#!/bin/sh
# shellcheck disable=SC2064

name=$(basename "$1")
dir=$(dirname "$1")
properName="${name#*-}"
pidFile="$dir/.$properName.pid"
if [ ! -x "$1" ]; then
    echo "$* invalid arg"
    exit 2
fi

[ -z "$SKIP_LOCK" ] && SKIP_LOCK=1 exec flock -n "$0" "$0" "$@"

echo $$ > "$pidFile"
SERVICE_LOG=${SERVICE_LOG_DIR:-/var/log}/$properName.log
[ -r "$SERVICE_LOG" ] && exec > "$SERVICE_LOG" 2>&1
trap "rm -f $pidFile; kill 0" EXIT
trap "kill 0" USR1
trap "exit" INT
trap "echo external signal received" TERM
while true; do
    echo respawning "$@"
    "$@" &
    wait $!
    [ $? -eq 127 ] && break
    sleep 1
done
